<!-- ================= HEADER ================= -->
<ion-header class="ion-no-border">
  <ion-toolbar class="main-header">
    <ion-buttons slot="start">
    </ion-buttons>
    <!-- Título a la izquierda -->
    <ion-title slot="start" class="page-title" mode="ios">
      <div class="page-title-container">
        <h1 class="page-title-text"><span>Rivas Express</span></h1>
      </div>
    </ion-title>

    <!-- Iconos agrupados a la derecha -->
    <ion-buttons slot="end">
      <!-- Botón Usuario que abre el Bottom Sheet -->
      <ion-button class="header-action-btn" (click)="setOpenMenu(true)">
        <ion-icon name="person-circle-outline"></ion-icon>
      </ion-button>

      <!-- Botón Salir -->
      <ion-button class="header-action-btn" (click)="logout()">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <!-- Buscador -->
  <ion-toolbar class="search-toolbar">
    <ion-searchbar
      mode="ios"
      placeholder="¿Qué se te antoja hoy?"
      (ionInput)="onSearch($event)"
      class="custom-search"
      [debounce]="500"
    ></ion-searchbar>
  </ion-toolbar>
</ion-header>

<!-- ================= MODAL TIPO BOTTOM SHEET (MENÚ MODERNO) ================= -->
<ion-modal
  [isOpen]="isMenuOpen()"
  (didDismiss)="setOpenMenu(false)"
  [initialBreakpoint]="0.3"
  [breakpoints]="[0, 0.3]"
  handleBehavior="cycle"
  mode="ios"
  class="user-bottom-sheet"
>
  <ng-template>
    <div class="sheet-content">
      <div class="sheet-header">
        <div class="handle-bar"></div>
        <h3>Mi Cuenta</h3>
      </div>

      <div class="sheet-menu-grid">
        <div class="menu-item" (click)="irAMisPedidos(); setOpenMenu(false)">
          <div class="icon-wrapper blue">
            <ion-icon name="receipt-outline"></ion-icon>
          </div>
          <span>Pedidos</span>
        </div>

        <div class="menu-item" (click)="irAlCarrito(); setOpenMenu(false)">
          <div class="icon-wrapper orange">
            <ion-icon name="cart"></ion-icon>
          </div>
          <span>Carrito</span>
        </div>
      </div>
    </div>
  </ng-template>
</ion-modal>

<!-- ================= CONTENIDO PRINCIPAL ================= -->
<ion-content class="client-page" fullscreen>
  <ion-refresher slot="fixed" (ionRefresh)="cargarProductos($event)">
  </ion-refresher>

  <!-- Categorías -->
  <div class="category-section">
    <div class="category-scroll">
      <!-- Carrito Flotante -->
      <div class="cart-chip" (click)="irAlCarrito()">
        <div class="cart-icon-container">
          <ion-icon name="cart"></ion-icon>
          @if (carritoService.cantidadTotal() > 0) {
            <span class="cart-badge-dot">{{
              carritoService.cantidadTotal()
            }}</span>
          }
        </div>
      </div>

      <div
        class="chip-item"
        [class.active]="categoriaSeleccionada() === null"
        (click)="seleccionarCategoria(null)"
      >
        Todos
      </div>
      @for (cat of categorias(); track cat.idCategoria) {
        <div
          class="chip-item"
          [class.active]="categoriaSeleccionada() === cat.idCategoria"
          (click)="seleccionarCategoria(cat.idCategoria)"
        >
          {{ cat.nombreCategoria }}
        </div>
      }
    </div>
  </div>

  <!-- Listado -->
  <div class="list-container ion-padding">
    @if (isLoading()) {
      <div class="loader-container">
        <ion-spinner name="crescent" color="primary"></ion-spinner>
      </div>
    } @else {
      @if (productos().length > 0) {
        <ion-grid class="ion-no-padding product-grid">
          <ion-row>
            @for (prod of productos(); track prod.idProducto) {
              <ion-col size="6" size-md="4" size-lg="3">
                <div class="product-card">
                  <div class="image-holder">
                    <img [src]="prod.imagen" [alt]="prod.nombreProducto" />
                    <div class="price-tag">
                      {{ prod.precio | currency: "C$" : "symbol" : "1.2-2" }}
                    </div>
                  </div>
                  <div class="product-body">
                    <div class="product-texts">
                      <h3>{{ prod.nombreProducto }}</h3>
                      <p>{{ prod.descripcionProducto }}</p>
                    </div>
                    <ion-button
                      expand="block"
                      class="add-button"
                      mode="ios"
                      (click)="agregarAlCarrito(prod)"
                    >
                      AGREGAR
                    </ion-button>
                  </div>
                </div>
              </ion-col>
            }
          </ion-row>
        </ion-grid>
      } @else {
        <div class="empty-container">
          <ion-icon name="restaurant-outline"></ion-icon>
          <h3>Sin resultados</h3>
          <p>No encontramos lo que buscas.</p>
        </div>
      }

      <!-- Paginación -->
      @if (totalPaginas() > 1) {
        <div class="pagination-container">
          <div class="pagination-btns">
            <ion-button
              fill="clear"
              (click)="prevPage()"
              [disabled]="paginaActual() === 1"
            >
              <ion-icon name="chevron-back-outline" slot="icon-only"></ion-icon>
            </ion-button>
            <div class="page-dot active"></div>
            <ion-button
              fill="clear"
              (click)="nextPage()"
              [disabled]="paginaActual() === totalPaginas()"
            >
              <ion-icon
                name="chevron-forward-outline"
                slot="icon-only"
              ></ion-icon>
            </ion-button>
          </div>

          <div class="page-indicator">
            Página <strong>{{ paginaActual() }}</strong> de
            <strong>{{ totalPaginas() }}</strong>
          </div>
        </div>
      }
    }
  </div>
</ion-content>
